<Page x:Class="javis.Pages.UpdatesPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Background="Transparent">

    <Grid Margin="14">
        <Border CornerRadius="16"
                Background="#22000000"
                BorderBrush="#33BFE9FF"
                BorderThickness="1"
                Padding="16">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <DockPanel Grid.Row="0" Margin="0,0,0,12">
                    <Button Content="← 뒤로가기" Click="Back_Click" Padding="12,6"/>
                    <TextBlock Text="업데이트" Foreground="#EAF6FF" FontSize="18" FontWeight="SemiBold"
                               VerticalAlignment="Center" Margin="12,0,0,0"/>
                </DockPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="최근 업데이트" Foreground="#A8C7D9" Margin="0,0,0,10"/>

                        <Border CornerRadius="12" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="14" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="CHANGELOG (latest)" Foreground="#EAF6FF" FontSize="14" FontWeight="SemiBold"/>
                                <TextBlock Margin="0,8,0,0" Foreground="#EAF6FF" TextWrapping="Wrap">
- 프로필(유저)별 데이터 분리: skills/plugins/persona/canon/vault/notes 등 주요 데이터가 ActiveUserDataDir 기준으로 분리됩니다.
- 스킬/플러그인/페르소나 개인화: 프로필마다 별도 폴더에서 로드/생성됩니다.
- 날짜별 인박스(inbox) 이벤트 로그 저장: users/&lt;id&gt;/inbox/daily/events-YYYY-MM-DD.jsonl (append-only)
- 인박스 빠른 탐색용 인덱스 생성: events-YYYY-MM-DD.idx.jsonl (kind + offset + length)
- 종료 시 컴팩션(정리) + 실패 시 재시도: 종료 중 실패/강제 종료돼도 다음 실행에서 자동 재시도합니다.
- 채팅 기록 저장 방식 개선: 실행 중에는 chat.message로 인박스에만 기록하고, 종료/재시작 컴팩션에서 세션으로 재구성합니다.
- 채팅 세션 분할: chat.request(메인), duo.request, solo.request 경계를 기반으로 같은 날짜 안에서도 여러 세션으로 분리 저장합니다.
- SOLO/DUO 인박스 기록 확장: solo/duo user/assistant/system 메시지도 room별로 저장되어 히스토리로 정리됩니다.
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border CornerRadius="12" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="14" Margin="0,0,0,10">
                            <StackPanel>
                                <TextBlock Text="TODO" Foreground="#EAF6FF" FontSize="14" FontWeight="SemiBold"/>
                                <TextBlock Margin="0,8,0,0" Foreground="#EAF6FF" TextWrapping="Wrap">
- 인박스 컴팩션 중복 방지(체크포인트/offset 기반)
- TODO/Vault/Canon/Profile 등 채팅 외 이벤트도 inbox 기록 + 종료 시 주제별 저장(compaction) 구현
- 인박스/로그 보관 정책(압축/정리)
- 기존 공용 데이터 → 유저별 데이터 마이그레이션 도구/UI
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border CornerRadius="12" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="14">
                            <StackPanel>
                                <TextBlock Text="메모" Foreground="#EAF6FF" FontSize="14" FontWeight="SemiBold"/>
                                <TextBlock Margin="0,8,0,0" Foreground="#EAF6FF" TextWrapping="Wrap">
- 종료 시 정리는 best-effort이며, 원본 events-*.jsonl은 자동 삭제하지 않습니다.
- 세션/주제 분류는 점진적으로 확장할 예정입니다.
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border CornerRadius="12" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="14" Margin="0,10,0,0">
                            <StackPanel>
                                <DockPanel>
                                    <TextBlock Text="문서화/업데이트 제안 (최근 20)" Foreground="#EAF6FF" FontSize="14" FontWeight="SemiBold"/>
                                    <Button DockPanel.Dock="Right" Content="새로고침" Padding="12,6" Command="{Binding RefreshCommand}"/>
                                </DockPanel>

                                <ListBox ItemsSource="{Binding DocSuggestions}" Background="Transparent" BorderThickness="0" Margin="0,10,0,0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="10" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="10" Margin="0,0,0,8">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Foreground="#A8C7D9" FontSize="11" Text="{Binding Ts}"/>
                                                        <TextBlock Foreground="#EAF6FF" FontSize="13" TextWrapping="Wrap" Text="{Binding Text}"/>
                                                        <TextBlock Foreground="#A8C7D9" FontSize="11" TextWrapping="Wrap" Text="{Binding Source, StringFormat=source: {0}}"/>
                                                    </StackPanel>

                                                    <Button Grid.Column="1" Content="처리됨" Padding="12,6" Margin="10,0,0,0"
                                                            Command="{Binding DataContext.ResolveCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                            CommandParameter="{Binding}"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <TextBlock Foreground="#A8C7D9" FontSize="11" TextWrapping="Wrap" Margin="0,6,0,0">
- 처리됨은 파일에서 삭제하지 않고 resolved 마킹만 합니다(append-only).
                                </TextBlock>
                            </StackPanel>
                        </Border>

                        <Border CornerRadius="12" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="14" Margin="0,10,0,0">
                            <StackPanel>
                                <DockPanel>
                                    <TextBlock Text="릴리즈 노트 (최근 20)" Foreground="#EAF6FF" FontSize="14" FontWeight="SemiBold"/>
                                    <Button DockPanel.Dock="Right" Content="새로고침" Padding="12,6" Command="{Binding RefreshCommand}"/>
                                </DockPanel>

                                <ListBox ItemsSource="{Binding ReleaseNotes}" Background="Transparent" BorderThickness="0" Margin="0,10,0,0">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="10" Background="#11000000" BorderBrush="#22FFFFFF" BorderThickness="1" Padding="10" Margin="0,0,0,8">
                                                <StackPanel>
                                                    <TextBlock Foreground="#A8C7D9" FontSize="11" Text="{Binding Ts}"/>
                                                    <TextBlock Foreground="#EAF6FF" FontSize="13" FontWeight="SemiBold" TextWrapping="Wrap" Text="{Binding Title}"/>
                                                    <TextBlock Foreground="#EAF6FF" FontSize="12" TextWrapping="Wrap" Text="{Binding Body}"/>
                                                    <TextBlock Foreground="#A8C7D9" FontSize="11" TextWrapping="Wrap" Text="{Binding Tag, StringFormat=tag: {0}}"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                <TextBlock Foreground="#A8C7D9" FontSize="11" TextWrapping="Wrap" Margin="0,6,0,0">
- 릴리즈 노트는 Copilot/개발자가 기능 구현 시 append하는 것이 정석입니다.
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</Page>
